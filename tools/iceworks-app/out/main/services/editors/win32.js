const e=require("path"),t=require("path-exists"),{ExternalEditor:o}=require("./shared"),r=require("../../logger"),{readRegistryKeySafe:i}=require("../../registry");function n(e){switch(e){case o.Atom:return["HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\atom"];case o.VisualStudioCode:return["HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{EA457B21-F73E-494C-ACAB-524FDE069978}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{1287CAD5-7C8D-410D-88B9-0D1EE4A83FF2}_is1","HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{771FD6B0-FA20-440A-A002-3B3BAC16DC50}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{F8A2A208-72B3-4D61-95FC-8A65D340689B}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{C26E74D1-022E-4238-8B9D-1E7564A36CC9}_is1","HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{D628A17A-9713-46BF-8D57-E671B46A741E}_is1"];case o.SublimeText:return["HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Sublime Text 3_is1"];case o.WebStorm:return["HKEY_CLASSES_ROOT\\Applications\\webstorm.exe\\shell\\open\\command"];default:return new Error(`Unknown external editor: ${e}`)}}function s(t,r){switch(t){case o.Atom:return e.join(r,"bin","atom.cmd");case o.VisualStudioCode:return e.join(r,"bin","code.cmd");case o.SublimeText:return e.join(r,"subl.exe");case o.WebStorm:return e.join(r,"bin","webstorm64.exe");default:return new Error(`Unknown external editor: ${t}`)}}function a(e,t,r){switch(e){case o.Atom:return"Atom"===t&&"GitHub Inc."===r;case o.VisualStudioCode:return("Microsoft Visual Studio Code"===t||"Microsoft Visual Studio Code Insiders"===t||"Microsoft Visual Studio Code (User)"===t)&&"Microsoft Corporation"===r;case o.SublimeText:return"Sublime Text"===t&&"Sublime HQ Pty Ltd"===r;case o.WebStorm:return"WebStorm"===t&&"JetBrains s.r.o."===r;default:return new Error(`Unknown external editor: ${e}`)}}function l(t,r){let i="",n="",s="";if(t===o.Atom){for(const e of r)"DisplayName"===e.name?i=e.value:"Publisher"===e.name?n=e.value:"InstallLocation"===e.name&&(s=e.value);return{displayName:i,publisher:n,installLocation:s}}if(t===o.VisualStudioCode){for(const e of r)"DisplayName"===e.name?i=e.value:"Publisher"===e.name?n=e.value:"InstallLocation"===e.name&&(s=e.value);return{displayName:i,publisher:n,installLocation:s}}if(t===o.SublimeText){for(const e of r)"DisplayName"===e.name&&e.value&&e.value.startsWith("Sublime Text")?i="Sublime Text":"Publisher"===e.name?n=e.value:"InstallLocation"===e.name&&(s=e.value);return{displayName:i,publisher:n,installLocation:s}}if(t===o.WebStorm){for(const t of r)if("(Default)"===t.name){i="WebStorm",n="JetBrains s.r.o.";const o=t.value.replace(' "%1"',"").replace(/\"/g,"");s=e.resolve(o,"../../")}return{displayName:i,publisher:n,installLocation:s}}return new Error(`Unknown external editor: ${t}`)}async function u(e){const o=n(e);let u=[];for(const e of o)if((u=await i(e)).length>0)break;if(0===u.length)return null;const{displayName:m,publisher:d,installLocation:c}=l(e,u);if(!a(e,m,d))return r.debug(`Registry entry for ${e} did not match expected publisher settings`),null;const S=s(e,c);return await t(S)?S:(r.debug(`Command line interface for ${e} not found at '${S}'`),null)}exports.parse=function(e){return e===o.Atom?o.Atom:e===o.VisualStudioCode?o.VisualStudioCode:e===o.SublimeText?o.SublimeText:e===o.WebStorm?o.WebStorm:null},exports.getAvailableEditors=async function(){const e=[],[t,r,i,n]=await Promise.all([u(o.Atom),u(o.VisualStudioCode),u(o.SublimeText),u(o.WebStorm)]);return t&&e.push({name:"Atom",editor:o.Atom,path:t}),r&&e.push({name:"VisualStudioCode",editor:o.VisualStudioCode,path:r}),i&&e.push({name:"SublimeText",editor:o.SublimeText,path:i}),n&&e.push({name:"WebStorm",editor:o.WebStorm,path:n}),e};