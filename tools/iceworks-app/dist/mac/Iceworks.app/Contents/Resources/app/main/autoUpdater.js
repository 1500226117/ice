const e=require("./logger"),{ipcMain:o}=require("electron"),{autoUpdater:a}=require("electron-updater"),{createUpdaterWindow:r}=require("./windowList"),t=require("./helper/sendToWebContents"),n=require("./services/interaction/notify");a.autoDownload=!1,a.logger=e;let d=null;function s(o,a=null){e.info(o,a),t(d,"updater-message",{event:o,meta:a})}o.on("set-updater-window-size",(e,{width:o,height:a})=>{d&&d.setContentSize(o,a)}),a.on("checking-for-update",()=>{s("checking-for-update")}),a.on("update-available",e=>{d?s("update-available",e):n({title:`\u5b58\u5728\u53ef\u7528\u66f4\u65b0 (${e.version})`,body:"\u70b9\u51fb\u8fdb\u5165\u66f4\u65b0\uff0c\u4f53\u9a8c\u65b0\u7248",type:"info",onClick:()=>{i.show()}})}),a.on("update-not-available",e=>{s("update-not-available",e)}),a.on("error",e=>{s("error",e)}),a.on("download-progress",e=>{s("download-progress",e)}),a.on("update-downloaded",e=>{s("update-downloaded",e)});const i={show:()=>{d?(d.show(),d.focus()):((d=r()).on("ready-to-show",()=>{d.show()}),d.on("close",()=>{d.destroy(),d=null}))},register:()=>{setInterval(()=>{a.checkForUpdates().catch(o=>{s("error",o),o.message=`Failed handling checkForUpdates: ${o.message}`,e.error(o)})},108e5),o.on("updater-check",()=>{a.checkForUpdates().catch(o=>{s("error",o),o.message=`Failed handling checkForUpdates: ${o.message}`,e.error(o)})}),o.on("updater-close",()=>{d.close()}),o.on("updater-start",()=>{a.downloadUpdate().catch(o=>{s("error",o),o.message=`Failed handling downloadUpdate: ${o.message}`,e.error(o)})}),o.on("updater-install",()=>{a.quitAndInstall()}),e.info("Updater starting..."),a.checkForUpdates().catch(o=>{o.message=`Failed handling checkForUpdatesAndNotify: ${o.message}`,e.error(o)})},checkForUpdatesAndNotify(){a.checkForUpdatesAndNotify().catch(o=>{o.message=`Failed handling checkForUpdatesAndNotify: ${o.message}`,e.error(o)})}};module.exports=i;