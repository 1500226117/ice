const e=require("fs"),r=require("kebab-case"),a=require("mkdirp"),t=require("path"),n=require("uppercamelcase"),i=require("path-exists"),s=require("./utils"),c=require("./pageTemplates"),o=require("prettier"),{DetailError:l}=require("../../error-handler"),u=require("../../config"),p=require("./appendRouteV3"),g=require("./appendRouteV4"),m=require("./appendMenuV4"),h=require("../../logger"),{emitProcess:P,emitError:d,emitProgress:f}=require("../../services/tracking");module.exports=async function({pageName:w,routePath:k,routeText:j,routeIcon:E,clientPath:y,clientSrcPath:I,layout:N,blocks:b=[],interpreter:D,preview:S=!1,builtIn:q=!1,libary:C="react",progressFunc:F}){const v=[];let T="";N&&(T=N.name),k=k||w;let $="checkPathValid";P($);const A=t.join(y,"package.json");let R={};if(!i.sync(A))throw d($,{message:"\u627e\u4e0d\u5230 package.json"}),new l("\u627e\u4e0d\u5230 package.json",{message:`\u5728${y}\u76ee\u5f55\u4e0b\u627e\u4e0d\u5230 package.json \u6587\u4ef6`});try{const r=e.readFileSync(A);R=JSON.parse(r.toString())}catch(r){throw d($,{message:"package.json \u5185\u5b58\u5728\u8bed\u6cd5\u9519\u8bef",pkg:e.readFileSync(A)}),new l("package.json \u5185\u5b58\u5728\u8bed\u6cd5\u9519\u8bef",{message:`\u8bf7\u68c0\u67e5${y}\u76ee\u5f55\u4e0b package.json \u7684\u8bed\u6cd5\u89c4\u8303`})}if(R.dependencies=R.dependencies||{},S&&(w="IceworksPreviewPage",k="IceworksPreviewPage",j="IceworksPreviewPage"),!await s.checkValidICEProject(y))return s.createInterpreter("UNSUPPORTED_DESTPATH",{clientPath:y},D),[];const x=n(w||"");w=r(x).replace(/^-/,"");const _=t.join(I,"pages",x);if(a.sync(_),q&&e.existsSync(_)&&e.readdirSync(_).length>0){if(!await s.createInterpreter("DESTDIR_EXISTS_OVERRIDE",{dir:_,clientPath:y},D))return[]}if(Array.isArray(b)){b.forEach(e=>{const r=e.alias||n(e.name)||e.className,a=n(e.alias||e.className||e.name);e.className=a,e.relativePath=`./components/${r}`});let e={};P($="generateBlocks"),f(!0);try{const r=await s.downloadBlocksToPage({clientPath:y,clientSrcPath:I,blocks:b,pageName:x,progressFunc:F});e=r.dependencies}catch(e){throw f(!1),e}if(f(!1),$="installBlockDeps",Object.keys(e).length>0){P($);let r=1,a=await s.createInterpreter("ADD_DEPENDENCIES",e,D);if(!a){r&&(r-=1,a=await s.createInterpreter("ADD_DEPENDENCIES",e,D));const t=b.map(({source:e})=>`${e.npm}@${e.version}`).join(" "),n=Object.keys(e).map(r=>`${r}@${e[r]}`).join(" ");throw new l("blocks \u4f9d\u8d56\u5b89\u88c5\u5931\u8d25\uff0c \u8bf7\u5728\u8bbe\u7f6e\u4e2d\u5207\u6362npm\u6e90\u5e76\u91cd\u8bd5",{message:`\u65e0\u6cd5\u5b89\u88c5\u4ee5\u4e0b\u533a\u5757\uff1a blocks: ${t} dependencies: ${n}`})}}}const O=R.scaffoldConfig||{},V={layout:N&&N.name||"",blocks:b,className:x,pageName:w,scaffoldConfig:O};P($="generatePage");const B=c(C).reduce((r,a)=>{try{const n=a.compile(V),i=a.fileName.replace(/PAGE/g,x).replace(/\.ejs$/g,""),s=t.join(_,i),c=t.extname(s);let l="vue"===C?"vue":"babylon";".scss"===c&&(l="scss");const p=o.format(n,Object.assign({},u.prettier,{parser:l}));return v.push(s),e.writeFileSync(s,p,"utf-8"),1&r}catch(e){return h.error(e),0&r}},1);let G=t.join(I,"router.jsx");const L=t.join(I,"routerConfig.js"),U=t.join(I,"menuConfig.js");return e.existsSync(G)||(G=t.join(I,"router.js")),P($="appendConfig"),i.sync(U)&&j&&(h.debug("\u5199\u5165 menuConfig",{name:j,path:k,menuConfigFilePath:U}),await m({name:j,path:k,menuConfigFilePath:U}).catch(h.debug)),i.sync(L)?(h.debug("\u5199\u5165 routerConfig",{name:j,path:k,menuConfigFilePath:U}),await g({routePath:k,routeFilePath:G,routerConfigFilePath:L,pageFolderName:x,layoutName:T}).catch(h.debug)):await p({clientPath:y,routePath:k,routeText:j,routeIcon:E,pageName:w,routeFilePath:G,pageFolderName:x,layoutClassName:n(T),preview:S,builtIn:q}).catch(()=>{}),v.push(G),B?await s.createInterpreter("FILE_CREATED",v,D):await s.createInterpreter("RENDER_PAGE_FAIL",!0,D),v};