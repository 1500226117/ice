const e=require("fs-extra"),t=require("path"),r=require("path-exists"),n=require("@icedesign/template-builder/utils/"),o=require("../../template"),i=require("../../logger"),s=require("../../glodlog"),a=require("../settings"),c=require("../../config/nodeScaffold"),{getClientPath:l,getServerPath:p}=require("../../paths");function u(e,t="",r=!1){const n=t&&r;return{destDir:t&&!r?l(e.targetPath,t):e.targetPath,scaffold:n?c[t].tarball:e.scaffold,progressFunc:e.progressFunc,projectName:e.projectName,interpreter:({type:e,message:t},r)=>{switch(i.info("generate project",e,t),e){case"FILE_CREATED":r(!0);break;default:r(!0)}}}}function f(n,o,s){if(n){i.debug("\u5185\u7f51\u7528\u6237\uff0c\u521b\u5efa abc.json");const n=t.join(o,"abc.json");return new Promise(t=>{const o={name:s,type:"iceworks",builder:"@ali/builder-iceworks"};r.sync(n)?t():e.writeFile(n,JSON.stringify(o,null,2),()=>{t()})})}return Promise.resolve()}function g(r,n){if(r){const r=n.directory;return new Promise((o,i)=>{const s=t.join(r,"package.json");let a;if("themeConfig"in n)try{a=e.readFileSync(s),(a=JSON.parse(a.toString())).themeConfig=n.themeConfig;const t=`${JSON.stringify(a,null,2)}\n`;e.writeFile(s,t,"utf-8",e=>{e?i(e):o(r)})}catch(e){i(e)}else o(r)})}return Promise.resolve()}function d(r,n){const o=p(r,n);e.readdir(o,"utf8",(r,n)=>{const i=/^_/;n.forEach(r=>{if(i.test(r)){const n=r.replace(i,".");e.renameSync(t.join(o,r),t.join(o,n))}})}),m(r,n)}function m(r,n){const{pendingFields:o}=c[n],i=l(r,n),s=t.join(i,"package.json"),a=t.join(r,"package.json"),p=t.join(i,"_package.json"),u=e.readJsonSync(p),f=e.readJsonSync(a),g=e.readJsonSync(s),d=/^[\^>>(?==)<<(?==)~]?([0-9]+(?=\.)[0-9]+)/;g.templateType=n,f.templateType=n,o.pkgAttrs.forEach(e=>{"scripts"===e?Object.keys(u[e]).forEach(t=>{g[e][t]=u[e][t]}):Object.keys(u[e]).forEach(t=>{if(g[e].hasOwnProperty(t)){const r=d.exec(u[e][t]),n=d.exec(g[e][t]);r&&n&&parseFloat(n[1])<parseFloat(r[1])&&(g[e][t]=u[e][t])}else g[e][t]=u[e][t]})}),e.writeJsonSync(s,g),e.writeJsonSync(a,f),e.removeSync(p)}module.exports=((e,t)=>{const{scaffold:r,layoutConfig:i,isCustomScaffold:c,targetPath:l,projectName:p,nodeFramework:m}=e,h=a.get("isAlibaba");let j,y,P;if(c)P=h,i.directory=l,i.name=p,j=n.generateTemplate(i);else{const n=r&&r.devDependencies||{};P=h&&n["ice-scripts"],m?(j=o.createProject(u(e,m,!0),t),y=o.createProject(u(e,m),t)):j=o.createProject(u(e),t)}return j.then(()=>{if(m)return new Promise(e=>{y.then(()=>{e()})})}).then(()=>{f(P,l,p)}).then(()=>{g(c,i)}).then(()=>{m&&d(l,m)}).then(()=>(s.record({type:"app",action:c?"custom-generator-project":m||"generator-project",scaffold:r.name||"custom-react-template",group:h?"alibaba":"outer"}),Promise.resolve()))});