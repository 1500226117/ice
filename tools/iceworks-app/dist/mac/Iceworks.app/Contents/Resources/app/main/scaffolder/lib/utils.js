const e=require("fs"),r=require("mkdirp"),n=require("path"),t=require("request"),o=require("tar"),s=require("uppercamelcase"),c=require("zlib"),i=require("request-progress"),a=require("path-exists"),p=require("await-to-js").default,u=require("../../config"),{DetailError:l}=require("../../error-handler"),d=require("../../template/utils"),m=require("../../utils/npmRequest"),g=require("../../logger"),f=require("../../glodlog"),y=require("../../utils/autoRetry");async function h({clientPath:e,clientSrcPath:r,blocks:n,pageName:t,progressFunc:o}){let s,c,i;if([s,c]=await p(Promise.all(n.map(async n=>await w({clientPath:e,clientSrcPath:r,pageName:t,block:n},o)))),s)throw s;const a=x(e),u=j(a);if([s,i]=await p(Promise.all(c.map(async(e,r)=>{const t=n[r];if(t.npm&&t.version&&"custom"!==t.type)return k({npm:t.npm,version:t.version});if(t.source&&"npm"===t.source.type&&"custom"!==t.type){let e=t.source.version;return"1.x"===u&&(e=t.source["version-0.x"]||t.source.version),k({version:e,npm:t.source.npm,registry:t.source.registry})}return"custom"===t.type?D(t):void 0}))),s)throw s.message="\u83b7\u53d6\u5f53\u524d\u533a\u5757\u7684\u4f9d\u8d56\u5931\u8d25",new Error(s);const l={};i.forEach(({dependencies:e})=>{Object.assign(l,e)});const d={};return Object.keys(l).forEach(e=>{a.dependencies.hasOwnProperty(e)||(d[e]=l[e])}),{dependencies:d}}async function w({clientPath:e,clientSrcPath:t,block:o,pageName:c},i){if(!o||!o.source&&"custom"!==o.type)throw new Error("block need to have specified source at download block to page method.");const a=n.join(t,"pages",c,"components");r.sync(a),f.record({type:"app",action:"download-block",data:{name:o.name}});const u=j(x(e)),l=o.alias||s(o.name)||o.className;let m,g,y;if("custom"===o.type){if([m,y]=await p(S(o,n.join(a,l),i)),m)throw new Error(`\u89e3\u538b\u81ea\u5b9a\u4e49\u533a\u5757${l}\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5`);return y}if([m,g]=await p(d.getTarballURLBySource(o.source,u)),m)throw m.message="\u8bf7\u6c42\u533a\u5757 tarball \u5305\u5931\u8d25",new Error(m);if([m,y]=await p(b(n.join(a,l),g,e,i)),m){if("ETIMEDOUT"===m.code||"ESOCKETTIMEDOUT"===m.code)throw new Error(`\u89e3\u538b\u533a\u5757${l}\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5`);throw new Error(`\u89e3\u538b\u533a\u5757${l}\u51fa\u9519, \u8bf7\u91cd\u8bd5`)}return y}function x(r){const t=n.join(r,"package.json");if(a.sync(t))try{const r=e.readFileSync(t);return JSON.parse(r.toString())}catch(e){g.error(e)}}function j(e={}){return(e.dependencies||{})["@icedesign/base"]?"0.x":"1.x"}function q(s,a,p,u=(()=>{})){return new Promise((l,d)=>{g.debug("npmTarball",a);const m=[];i(t({url:a,timeout:1e4})).on("progress",e=>{u(e)}).on("error",e=>{e.name="download-tarball-error",e.data={url:a},g.error(e),d(e)}).pipe(c.Unzip()).pipe(o.Parse()).on("entry",t=>{if(!/src|mock\//.test(t.path))return;let o="";if(-1!==t.path.indexOf("mock/"))o=n.join(p,t.path.replace(/^package\//,""));else{const e=t.path.replace(/^package\//,"").replace(/src/g,"");o=n.join(s,e)}g.debug("\u5199\u5165\u6587\u4ef6",o),e.existsSync(o)||(r.sync(n.dirname(o)),t.pipe(e.createWriteStream(o)),m.push(o))}).on("end",()=>{u({percent:1}),l(m)})})}const P=2,b=y(q,2,e=>e.code&&("ETIMEDOUT"===e.code||"ESOCKETTIMEDOUT"===e.code));function E(e,r="latest"){return new Promise((n,t)=>{m({name:e,version:r}).then(e=>{n(e.dist.tarball)}).catch(t)})}function k({npm:e,version:r="latest",registry:n}){return new Promise((t,o)=>{m({name:e,version:r,registry:n}).then(e=>{t({dependencies:e.dependencies||{},devDependencies:e.devDependencies||{},peerDependencies:e.peerDependencies||{}})}).catch(n=>{o(new l(`${e}@${r} not found`,{body:n,message:`${e}@${r} \u4e0d\u5b58\u5728`}))})})}const v="cn";async function T(e={}){return{dependencies:e.components||{}}}function S(t,o,s){return new Promise(c=>{const i=[],a=t.code;r.sync(o),e.writeFileSync(n.join(o,"index.jsx"),a["index.jsx"]),i.push(n.join(o,"index.jsx")),s({percent:1}),c(i)})}function D(e){return new Promise(r=>{const n={};JSON.parse(e.dep).forEach(e=>{n[e.npmName]=e.version}),r({dependencies:n})})}exports.createInterpreter=function(e,r={},n){const t=(u.locale[e]||u.locale.unknown).cn;return new Promise(o=>{n({type:e,message:t,data:r},e=>{o(e)})})},exports.checkValidICEProject=function(r){if(!e.existsSync(r))return!1;const t=n.join(r,"package.json");try{const e=require(t);return"scaffoldConfig"in e||"buildConfig"in e}catch(e){g.error(e)}try{const e=n.join(r,"abc.json"),t=require(e);return"project"===t.repository.type&&"ice"===t.type}catch(e){return!1}},exports.extractCustomBlock=S,exports.getDependenciesFromCustom=D,exports.getTarballURL=E,exports.getDependenciesFromNpm=k,exports.getDependenciesFromMaterial=T,exports.downloadBlockToPage=w,exports.downloadBlocksToPage=h,exports.getPackageByPath=x,exports.getProjectVersion=j;